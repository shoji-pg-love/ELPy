<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>N-Gram Comparer</title>
    <style>
      :root {
        --bg: #f7f7f8;
        --card: #fff;
        --border: #d1d5db;
        --text: #111827;
        --accent: #2563eb;
        --stripe: #d4d4d8;
        --match: #bbf7d0;
        --block: #2563eb;
        --highlight: #fde2e2;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui;
        background: var(--bg);
        color: var(--text);
      }
      h1 {
        text-align: center;
        margin: 1.5rem 0;
        font-size: 2rem;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1.25rem;
        align-items: flex-end;
      }
      label {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        display: block;
      }
      input[type="number"],
      input[type="file"] {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 1rem;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 0.6rem 1.25rem;
        font-size: 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background: #1d4ed8;
      }
      button:disabled {
        background: #9ca3af;
        cursor: default;
      }
      .table-wrap {
        overflow: auto;
        border: 1px solid var(--border);
        height: 100vh;
      }
      table {
        border-collapse: collapse;
        min-width: 600px;
        width: max-content;
      }
      th,
      td {
        border: 1px solid var(--border);
        padding: 0.4rem 0.6rem;
        text-align: left;
        white-space: nowrap;
      }
      th {
        background: #f3f4f6;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 4;
      }
      .rank-sticky {
        position: sticky;
        left: 0;
        z-index: 4;
        background: #fff;
        min-width: 60px;
        text-align: right;
        padding-right: 0.75rem;
      }
      th.rank-sticky {
        top: 0;
        left: 0;
        z-index: 7;
        background: #f3f4f6;
      }
      .base-sticky {
        position: sticky;
        left: 60px;
        z-index: 5;
        background: #fff;
        min-width: 200px;
      }
      th.base-sticky {
        top: 0;
        background: #f3f4f6;
        z-index: 6;
      }
      .rank-strip {
        background: var(--stripe);
      }
      .match {
        background: var(--match) !important;
      }
      .block-top td,
      .block-top th {
        border-top: 3px solid var(--block);
      }
      .block-summary {
        background: #e5f7dc;
      }
      .highlight {
        background: var(--highlight) !important;
      }
    </style>
  </head>
  <body>
    <h1>N-Gram Comparer</h1>
    <div class="container">
      <div class="card">
        <div class="controls">
          <div>
            <label for="baseFile">Base file (single)</label
            ><input id="baseFile" type="file" accept=".txt" />
          </div>
          <div>
            <label for="compareFiles">Compare files (multiple)</label
            ><input id="compareFiles" type="file" multiple accept=".txt" />
          </div>
          <div>
            <label for="nval">n-gram length</label
            ><input id="nval" type="number" min="1" value="1" />
          </div>
          <div>
            <label for="limit">Top limit</label
            ><input id="limit" type="number" min="1" value="200" />
          </div>
          <div>
            <label for="blockSize">Block size</label
            ><input id="blockSize" type="number" min="1" value="20" />
          </div>
          <button id="analyse" disabled style="align-self: center">
            Analyse
          </button>
        </div>
      </div>
      <div id="output"></div>
    </div>

    <script>
      const WORD_RE = /\b\w+\b/g;
      const tokenize = (t) => t.toLowerCase().match(WORD_RE) || [];
      const makeNGrams = (tok, n) => {
        const r = [];
        for (let i = 0; i <= tok.length - n; i++)
          r.push(tok.slice(i, i + n).join(" "));
        return r;
      };
      const buildCounter = (txt, n) => {
        const m = new Map();
        makeNGrams(tokenize(txt), n).forEach((g) =>
          m.set(g, (m.get(g) || 0) + 1)
        );
        return m;
      };
      const topItems = (ctr, lim) =>
        Array.from(ctr.entries())
          .sort((a, b) => b[1] - a[1] || (a[0] > b[0] ? 1 : -1))
          .slice(0, lim)
          .map((e) => e[0]);

      const els = {
        base: document.getElementById("baseFile"),
        cmp: document.getElementById("compareFiles"),
        n: document.getElementById("nval"),
        limit: document.getElementById("limit"),
        blockSize: document.getElementById("blockSize"),
        btn: document.getElementById("analyse"),
        out: document.getElementById("output"),
      };
      let baseBlob = null,
        cmpBlobs = [];
      const toggleBtn = () =>
        (els.btn.disabled = !baseBlob || cmpBlobs.length === 0);
      els.base.addEventListener("change", (e) => {
        baseBlob = e.target.files[0] || null;
        toggleBtn();
      });
      els.cmp.addEventListener("change", (e) => {
        cmpBlobs = [...e.target.files];
        toggleBtn();
      });

      els.btn.addEventListener("click", async () => {
        els.out.innerHTML = "";
        const n = parseInt(els.n.value) || 1,
          limit = parseInt(els.limit.value) || 200,
          STEP = parseInt(els.blockSize.value) || 20;
        const blobs = [baseBlob, ...cmpBlobs];
        const texts = await Promise.all(blobs.map((f) => f.text()));
        const ranks = texts.map((t) => topItems(buildCounter(t, n), limit));
        const blocks = Math.ceil(limit / STEP);

        // 各ブロック共通n-gram集合
        const intersections = cmpBlobs.map(() =>
          Array.from({ length: blocks }, () => new Set())
        );
        for (let b = 0; b < blocks; b++) {
          const baseSet = new Set(ranks[0].slice(b * STEP, b * STEP + STEP));
          cmpBlobs.forEach((_, idx) => {
            ranks[idx + 1].slice(b * STEP, b * STEP + STEP).forEach((g) => {
              if (baseSet.has(g)) intersections[idx][b].add(g);
            });
          });
        }
        // 各ブロック一致数
        const blockSharedCounts = intersections.map((arr) =>
          arr.map((s) => s.size)
        );

        // テーブル構築
        const wrap = document.createElement("div");
        wrap.className = "table-wrap";
        const tbl = document.createElement("table");
        wrap.appendChild(tbl);

        // ヘッダー
        const thead = tbl.createTHead().insertRow();
        const thR = thead.insertCell();
        thR.textContent = "Rank";
        thR.className = "rank-sticky";
        blobs.forEach((f) => {
          const th = thead.insertCell();
          th.textContent = f.name;
        });
        thead.children[1].classList.add("base-sticky");

        const tbody = tbl.createTBody();

        // 各ブロックのデータ行＋サマリー行
        for (let b = 0; b < blocks; b++) {
          const start = b * STEP,
            end = Math.min((b + 1) * STEP, limit);
          // データ行
          for (let r = start; r < end; r++) {
            const tr = tbody.insertRow();
            if (r % STEP === 0) tr.classList.add("block-top");
            const blk = Math.floor(r / STEP);
            const tdRank = tr.insertCell();
            tdRank.textContent = r + 1;
            tdRank.className = "rank-sticky";
            if (blk % 2 === 1) tdRank.classList.add("rank-strip");
            const baseGram = ranks[0][r] || "";
            const tdBase = tr.insertCell();
            tdBase.textContent = baseGram;
            tdBase.title = baseGram;
            tdBase.className = "base-sticky truncate";
            if (baseGram && intersections.some((arr) => arr[blk].has(baseGram)))
              tdBase.classList.add("match");
            cmpBlobs.forEach((_, idx) => {
              const gram = ranks[idx + 1][r] || "";
              const td = tr.insertCell();
              td.textContent = gram;
              td.title = gram;
              td.className = "truncate";
              if (gram && intersections[idx][blk].has(gram))
                td.classList.add("match");
            });
          }
          // サマリー行
          const summ = tbody.insertRow();
          summ.className = "block-summary";
          const tdLabel = summ.insertCell();
          tdLabel.textContent = `${start + 1}–${end} shared`;
          tdLabel.className = "rank-sticky";
          const tdEmpty = summ.insertCell();
          tdEmpty.className = "base-sticky";
          // 各比較文書ごとに 一致数(累積) ＆ ハイライト判定
          const cumulatives = blockSharedCounts.map((counts) =>
            counts.slice(0, b + 1).reduce((a, c) => a + c, 0)
          );
          const maxCum = Math.max(...cumulatives);
          blockSharedCounts.forEach((counts, idx) => {
            const td = summ.insertCell();
            const cum = cumulatives[idx],
              cnt = counts[b];
            td.textContent = `${cnt}(${cum})`;
            if (cum === maxCum) td.classList.add("highlight");
          });
        }

        els.out.appendChild(wrap);
      });
    </script>
  </body>
</html>
